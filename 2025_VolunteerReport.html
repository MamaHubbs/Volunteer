<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Requirement Report - Families</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }
    .main-content-wrapper {
      width: 890px;
      margin: 0 auto;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    .dropdown-container {
      text-align: center;
      margin-bottom: 12px;
    }
    .dropdown-box {
      display: inline-block;
      margin: 0 10px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }
    select, input[type="text"] {
      padding: 4px 8px;
      font-size: 0.8em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #familyNameFilterSelect {
      width: 250px;
    }
    #familySearchInput {
      min-width: 180px;
    }
    table {
      table-layout: fixed;
      width: 100%;
      max-width: 890px;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 50px;
      z-index: 1;
      cursor: pointer;
      white-space: nowrap;
      color: #0156B3;
    }
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #eaf6ff; }
    .met-yes { font-weight: bold; color: #28a745; text-align: center; }
    .met-no { font-weight: bold; color: #dc3545; text-align: center; }

    th:nth-child(1), td:nth-child(1) { width: 32%; } /* Meet */
    th:nth-child(2), td:nth-child(2) { width: 33%; } /* Swimmers */
    th:nth-child(3), td:nth-child(3) { width: 17%; } /* Jobs */
    th:nth-child(4), td:nth-child(4),
    th:nth-child(5), td:nth-child(5),
    th:nth-child(6), td:nth-child(6) {
      width: 6%;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="main-content-wrapper">
    <h1>Volunteer Requirement Report (by Family)</h1>
    <p>Each row represents a family's participation and volunteer status for a given meet.</p>
    <div class="dropdown-container">
      <div class="dropdown-box">
        <label for="familyNameFilterSelect">Filter by Family:</label>
        <select id="familyNameFilterSelect">
          <option value="">All Families</option>
        </select>
      </div>
      <div class="dropdown-box">
        <label for="familySearchInput">Search Family Name:</label>
        <input type="text" id="familySearchInput" placeholder="e.g. Ackerson" />
      </div>
      <div class="dropdown-box">
        <label for="metRequirementFilter">Filter by Met:</label>
        <select id="metRequirementFilter">
          <option value="">All</option>
          <option value="YES">Met</option>
          <option value="NO">Not Met</option>
          <option value="N/A">N/A</option>
        </select>
      </div>
    </div>
    <div id="report-container">Loading...</div>
  </div>
  <script>
    const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_swimmerdata.json';
    const VOLUNTEER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_volunteerdata.json';

    function formatMeetDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return "N/A";
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${mm}-${dd}-${yyyy}`;
    }

    function extractLastName(name) {
      if (!name) return "";
      const commaSplit = name.split(",");
      return commaSplit.length === 2 ? commaSplit[0].trim() : name.trim().split(" ").pop();
    }

    function renderTable(data) {
      const container = document.getElementById('report-container');
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr>
        <th>Meet</th>
        <th>Swimmer(s)</th>
        <th>Job(s)</th>
        <th>Swam?</th>
        <th>Worked?</th>
        <th>Met?</th>
      </tr></thead><tbody>
        ${data.map(row => `
          <tr>
            <td>${row.meet}</td>
            <td>${row.swimmers}</td>
            <td>${row.jobs}</td>
            <td>${row.competed}</td>
            <td>${row.volunteered}</td>
            <td class="met-${row.met === 'YES' ? 'yes' : row.met === 'NO' ? 'no' : 'na'}">${row.met}</td>
          </tr>`).join('')}
      </tbody>`;
      container.innerHTML = '';
      container.appendChild(table);
    }

    function applyFilters(data, familyFilter, searchText, metFilter) {
      return data.filter(row => {
        const matchesFamily = !familyFilter || row.family === familyFilter;
        const matchesSearch = !searchText || row.family.toLowerCase().includes(searchText.toLowerCase());
        const matchesMet = !metFilter || row.met === metFilter;
        return matchesFamily && matchesSearch && matchesMet;
      });
    }

    async function fetchAndRender() {
      const res1 = await fetch(SWIMMER_DATA_URL);
      const res2 = await fetch(VOLUNTEER_DATA_URL);
      const swimmerJson = await res1.json();
      const volunteerJson = await res2.json();
      const swimmers = swimmerJson.values.map(row => Object.fromEntries(swimmerJson.fields.map((k, i) => [k, row[i]])));
      const volunteers = volunteerJson.values.map(row => Object.fromEntries(volunteerJson.fields.map((k, i) => [k, row[i]])));

      const reportMap = new Map();
      const volunteerLastNameMap = {};

      for (const v of volunteers) {
        if (v["Parent"] && v["Parent Last Name"]) {
          volunteerLastNameMap[v["Parent"].trim()] = v["Parent Last Name"].trim();
        }
      }

      for (const s of swimmers) {
        const parentString = s["Associated Parents For Swimmer"];
        const parentLastName = s["Parent Last Name"];
        if (parentString && parentLastName) {
          parentString.split(';').forEach(p => {
            const name = p.trim();
            if (name && !volunteerLastNameMap[name]) {
              volunteerLastNameMap[name] = parentLastName.trim();
            }
          });
        }
      }

      for (const row of swimmers) {
        const meetDate = row["Meet Date"];
        const meetName = row["Meet Name"];
        const swimmer = row["Swimmer Name"];
        const parents = row["Associated Parents For Swimmer"];
        if (!meetDate || !meetName || !swimmer || !parents || row["Count of Events With Results"] <= 0) continue;
        const parentSet = new Set(parents.split(';').map(p => p.trim()));
        const parentSetKey = Array.from(parentSet).sort().join('|');
        const firstParent = parentSetKey.split('|')[0];
        const parentLastName = volunteerLastNameMap[firstParent] || extractLastName(firstParent);
        const familyName = `${parentLastName} Family`;
        const key = `${meetDate}|${meetName}|${familyName}`;
        if (!reportMap.has(key)) {
          reportMap.set(key, {
            "Meet Date": meetDate,
            "Meet Name": meetName,
            family: familyName,
            Swimmers: new Set(),
            Jobs: new Set(),
            Competed: false,
            Volunteered: false
          });
        }
        const entry = reportMap.get(key);
        entry.Swimmers.add(swimmer);
        entry.Competed = true;
      }

      for (const row of volunteers) {
        const meetDate = row["Meet Date"];
        const meetName = row["Meet Name"];
        const parent = row["Parent"];
        const job = row["Job"];
        if (!meetDate || !meetName || !parent || !job) continue;
        const familyName = `${extractLastName(parent)} Family`;
        const key = `${meetDate}|${meetName}|${familyName}`;
        if (!reportMap.has(key)) {
          reportMap.set(key, {
            "Meet Date": meetDate,
            "Meet Name": meetName,
            family: familyName,
            Swimmers: new Set(),
            Jobs: new Set(),
            Competed: false,
            Volunteered: false
          });
        }
        const entry = reportMap.get(key);
        entry.Jobs.add(job);
        entry.Volunteered = true;
      }

      const allRows = Array.from(reportMap.values()).map(entry => {
        const met = entry.Competed ? (entry.Volunteered ? "YES" : "NO") : "N/A";
        return {
          meet: `${formatMeetDate(entry["Meet Date"])} ${entry["Meet Name"]}`,
          family: entry.family,
          swimmers: Array.from(entry.Swimmers).join(", ") || "-",
          jobs: Array.from(entry.Jobs).join(", ") || "-",
          competed: entry.Competed ? "YES" : "NO",
          volunteered: entry.Volunteered ? "YES" : "NO",
          met
        };
      });

      const familyFilterSelect = document.getElementById("familyNameFilterSelect");
      const families = [...new Set(allRows.map(r => r.family))].sort();
      families.forEach(fam => {
        const opt = document.createElement("option");
        opt.value = fam;
        opt.textContent = fam;
        familyFilterSelect.appendChild(opt);
      });

      const filterRows = () => {
        const famFilter = familyFilterSelect.value;
        const search = document.getElementById("familySearchInput").value;
        const met = document.getElementById("metRequirementFilter").value;
        const filtered = applyFilters(allRows, famFilter, search, met);
        renderTable(filtered);
      };

      document.getElementById("familyNameFilterSelect").addEventListener("change", filterRows);
      document.getElementById("familySearchInput").addEventListener("input", filterRows);
      document.getElementById("metRequirementFilter").addEventListener("change", filterRows);

      renderTable(allRows);
    }

    document.addEventListener('DOMContentLoaded', fetchAndRender);
  </script>
</body>
</html>
