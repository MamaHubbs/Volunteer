<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteer Requirement Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        p { color: #555; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
        th { background-color: #f2f2f2; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .competed-yes { background-color: #e6ffe6; } /* Light green */
        .competed-no { background-color: #fff0f0; } /* Light red */
        .met-yes { font-weight: bold; color: green; }
        .met-no { font-weight: bold; color: red; }
        .met-na { color: gray; }
        .loading-message { color: blue; font-style: italic; }
        .error-message { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Volunteer Requirement Report</h1>
    <p>This report helps compare swimmers who competed in a meet with parents who volunteered. <br>
       <strong>Rule:</strong> If a family had a swimmer competing in a meet, a parent should have volunteered for that meet.</p>

    <div id="report-container" class="loading-message">Loading report data...</div>

    <script>

        const PARENT_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_volunteerdata.json';
        const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_swimmerdata.json';

        async function loadJsonData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} for ${url}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error loading data from ${url}:`, error);
                const container = document.getElementById('report-container');
                container.innerHTML = `<p class="error-message">Failed to load data from ${url}. Please check the URL and network connection. Error: ${error.message}</p>`;
                throw error; // Re-throw to stop further processing
            }
        }

        async function generateReport() {
            const container = document.getElementById('report-container');
            container.innerHTML = '<p class="loading-message">Processing data...</p>';

            let swimmersCompetingRaw = [];
            let parentVolunteersRaw = [];

            try {
                swimmersCompetingRaw = await loadJsonData(SWIMMER_DATA_URL);
                parentVolunteersRaw = await loadJsonData(PARENT_DATA_URL);
            } catch (error) {
                // Error already handled by loadJsonData, just return
                return;
            }

            if (!swimmersCompetingRaw.length && !parentVolunteersRaw.length) {
                container.innerHTML = "<p>No data loaded to generate report.</p>";
                return;
            }

            // --- Step 1: Create a lookup for swimmers who competed in each meet ---
            // Structure: {'Meet Name': {'YYYY-MM-DD': Set('Swimmer Name')}}
            const competedSwimmersByMeet = {};
            swimmersCompetingRaw.forEach(row => {
                const meetName = row["Meet Name"];
                const meetDate = row["Meet Date"];
                const swimmerName = row["Swimmer Name"]; // Use bracket notation for consistency with original SQL alias
                const countResults = row["Count of Events With Results"] || 0; // Use 0 if not present

                if (meetName && meetDate && swimmerName && countResults > 0) {
                    if (!(meetName in competedSwimmersByMeet)) {
                        competedSwimmersByMeet[meetName] = {};
                    }
                    if (!(meetDate in competedSwimmersByMeet[meetName])) {
                        competedSwimmersByMeet[meetName][meetDate] = new Set();
                    }
                    competedSwimmersByMeet[meetName][meetDate].add(swimmerName);
                }
            });

            // --- Step 2: Process Parent Volunteer Data ---
            const reportRows = [];
            const processedParentJobCombos = new Set(); // To prevent duplicate parent job rows
            const processedSwimmerMeetCombos = new Set(); // To track which swimmers have been covered by parent jobs

            parentVolunteersRaw.forEach(parentRow => {
                const meetDate = parentRow["Meet Date"];
                const meetName = parentRow["Meet Name"];
                const parentName = parentRow.Parent;
                const job = parentRow.Job;
                const shift = parentRow.Shift;
                const points = parentRow.Points;

                // Create a unique identifier for this specific parent job/shift entry
                const parentJobId = `${meetDate}|${meetName}|${parentName}|${job}|${shift}|${points}`;
                if (processedParentJobCombos.has(parentJobId)) {
                    return; // Skip if already processed (can happen if original SQL produced duplicates before GROUP BY)
                }
                processedParentJobCombos.add(parentJobId);

                const associatedSwimmersList = [];
                for (let i = 1; i <= 9; i++) { // Assuming Swimmer 1 to Swimmer 9 columns
                    const swimmerCol = parentRow[`Swimmer ${i}`];
                    if (swimmerCol) {
                        associatedSwimmersList.push(swimmerCol);
                    }
                }

                let competedStatus = "NO";
                // Check if ANY associated swimmer competed in THIS meet
                for (const swimmer of associatedSwimmersList) {
                    if (meetName in competedSwimmersByMeet &&
                       meetDate in competedSwimmersByMeet[meetName] &&
                       competedSwimmersByMeet[meetName][meetDate].has(swimmer)) {
                        competedStatus = "YES";
                        // Mark swimmer as covered by a volunteering parent for this meet
                        processedSwimmerMeetCombos.add(`${meetDate}|${meetName}|${swimmer}`);
                    }
                }

                // Determine if requirement is met based on the rule
                let metRequirement;
                if (competedStatus === "YES") {
                    metRequirement = "YES"; // Child competed AND parent volunteered for this meet
                } else {
                    metRequirement = "N/A (No Child Competed)"; // Parent volunteered, but no child competed in this meet
                }

                reportRows.push({
                    "Meet Date": meetDate,
                    "Meet Name": meetName,
                    "Swimmer Name": associatedSwimmersList.length ? associatedSwimmersList.join(", ") : "N/A", // Display all associated swimmers for parent row
                    "Competed YES/NO": competedStatus,
                    "Parent Name": parentName,
                    "Job": job,
                    "Shift": shift,
                    "Points": points,
                    "Met Requirement": metRequirement
                });
            });

            // --- Step 3: Add Swimmers who competed but whose parents did NOT volunteer for that specific meet ---
            // These are the "missed requirements"
            for (const meetName in competedSwimmersByMeet) {
                for (const meetDate in competedSwimmersByMeet[meetName]) {
                    for (const swimmerName of competedSwimmersByMeet[meetName][meetDate]) {
                        // If this swimmer-meet combo was NOT covered by a parent who volunteered, add a row for them
                        if (!processedSwimmerMeetCombos.has(`${meetDate}|${meetName}|${swimmerName}`)) {
                            reportRows.push({
                                "Meet Date": meetDate,
                                "Meet Name": meetName,
                                "Swimmer Name": swimmerName,
                                "Competed YES/NO": "YES", // Confirmed child competed
                                "Parent Name": "N/A (No Volunteer)", // No parent volunteered for this specific meet
                                "Job": "N/A",
                                "Shift": "N/A",
                                "Points": "N/A",
                                "Met Requirement": "NO (Child Competed, Parent Not Volunteered)" // Clear failure to meet requirement
                            });
                        }
                    }
                }
            }

            // --- Step 4: Sort the report rows for better readability ---
            reportRows.sort((a, b) => {
                let comparison = a["Meet Date"].localeCompare(b["Meet Date"]);
                if (comparison !== 0) return comparison;
                comparison = a["Meet Name"].localeCompare(b["Meet Name"]);
                if (comparison !== 0) return comparison;
                // Custom sort to put "N/A (No Volunteer)" rows at the end of a group for a meet
                const parentA = a["Parent Name"] === "N/A (No Volunteer)" ? "ZZZ" : a["Parent Name"]; // "ZZZ" sorts after most names
                const parentB = b["Parent Name"] === "N/A (No Volunteer)" ? "ZZZ" : b["Parent Name"];
                comparison = parentA.localeCompare(parentB);
                if (comparison !== 0) return comparison;
                return a["Swimmer Name"].localeCompare(b["Swimmer Name"]); // Final tie-breaker by swimmer name
            });

            // --- Step 5: Generate and insert HTML Table ---
            let tableHtml = `
                <table>
                    <thead>
                        <tr>
                            <th>Meet Date</th>
                            <th>Meet Name</th>
                            <th>Swimmer(s)</th>
                            <th>Competed?</th>
                            <th>Parent Name</th>
                            <th>Job</th>
                            <th>Shift</th>
                            <th>Points</th>
                            <th>Met Requirement</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            reportRows.forEach(rowData => {
                const competedClass = rowData["Competed YES/NO"] === "YES" ? "competed-yes" : "competed-no";
                const metClass = rowData["Met Requirement"] === "YES" ? "met-yes" :
                                 (rowData["Met Requirement"].startsWith("NO") ? "met-no" : "met-na"); // Check for "NO" at start

                tableHtml += `
                    <tr class="${competedClass}">
                        <td>${rowData["Meet Date"] || "N/A"}</td>
                        <td>${rowData["Meet Name"] || "N/A"}</td>
                        <td>${rowData["Swimmer Name"] || "N/A"}</td>
                        <td>${rowData["Competed YES/NO"] || "N/A"}</td>
                        <td>${rowData["Parent Name"] || "N/A"}</td>
                        <td>${rowData["Job"] || "N/A"}</td>
                        <td>${rowData["Shift"] || "N/A"}</td>
                        <td>${rowData["Points"] || "N/A"}</td>
                        <td class="${metClass}">${rowData["Met Requirement"] || "N/A"}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHtml; // Insert the generated table
        }

        // Run the report generation when the page loads
        document.addEventListener('DOMContentLoaded', generateReport);
    </script>
</body>
</html>
