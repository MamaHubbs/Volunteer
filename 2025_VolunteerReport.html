<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Requirement Report - Families</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }
    .main-content-wrapper {
      width: 890px;
      margin: 0 auto;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    .dropdown-container {
      text-align: center;
      margin-bottom: 12px;
    }
    .dropdown-box {
      display: inline-block;
      margin: 0 10px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 4px;
    }
    select, input[type="text"] {
      padding: 4px 8px;
      font-size: 0.8em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    #familyNameFilterSelect {
      width: 250px;
    }
    #familySearchInput {
      min-width: 180px;
    }
    table {
      table-layout: fixed;
      width: 100%;
      max-width: 890px;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 50px;
      z-index: 1;
      cursor: pointer;
      white-space: nowrap;
      color: #0156B3;
    }
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #eaf6ff; }
    .met-yes { font-weight: bold; color: #28a745; text-align: center; }
    .met-no { font-weight: bold; color: #dc3545; text-align: center; }

    th:nth-child(1), td:nth-child(1) { width: 25%; }
    th:nth-child(2), td:nth-child(2) { width: 13%; }
    th:nth-child(3), td:nth-child(3) { width: 20%; }
    th:nth-child(4), td:nth-child(4) { width: 20%; }
    th:nth-child(5), td:nth-child(5) { width: 12%; }
    th:nth-child(6), td:nth-child(6),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(8), td:nth-child(8) {
      width: 4%;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="main-content-wrapper">
    <h1>Volunteer Requirement Report (by Family)</h1>
    <p>Each row represents a family's participation and volunteer status for a given meet.</p>
    <div class="dropdown-container">
      <div class="dropdown-box">
        <label for="familyNameFilterSelect">Filter by Family:</label>
        <select id="familyNameFilterSelect">
          <option value="">All Families</option>
        </select>
      </div>
      <div class="dropdown-box">
        <label for="familySearchInput">Search Family Name:</label>
        <input type="text" id="familySearchInput" placeholder="e.g. Ackerson" />
      </div>
    </div>
    <div id="report-container">Loading...</div>
  </div>
  <script>
    const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_swimmerdata.json';
    const VOLUNTEER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_volunteerdata.json';

    const swimmerFields = [
      "Meet Date", "Meet Name", "Parent", "Job", "Assignment",
      "Count of Events With Results",
      "Swimmer 1", "Swimmer 2", "Swimmer 3", "Swimmer 4",
      "Swimmer 5", "Swimmer 6", "Swimmer 7", "Swimmer 8", "Swimmer 9"
    ];

    const volunteerFields = [
      "Meet Date", "Meet Name", "Swimmer Name",
      "Count of Events With Results", "Volunteer Count",
      "Associated Parents For Swimmer"
    ];

    function extractFirstName(fullName) {
      if (!fullName) return "";
      const parts = fullName.split(",");
      return parts.length === 2 ? parts[1].trim().split(" ")[0] : fullName.trim().split(" ")[0];
    }

    function extractLastName(name) {
      if (!name) return "";
      if (name.includes(",")) {
        return name.split(",")[0].trim();
      }
      const parts = name.trim().split(" ");
      return parts.length > 1 ? parts.at(-1) : parts[0];
    }

    async function loadJsonData(url, fields) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to load ${url}`);
      const raw = await res.json();
      return raw.values.map(row => Object.fromEntries(fields.map((key, i) => [key, row[i]])));
    }

    function updateFamilyDropdown(options) {
      const select = document.getElementById('familyNameFilterSelect');
      select.innerHTML = '<option value="">All Families</option>';
      options.sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    }

    function applyFiltersAndRender(dataRows) {
      let filtered = dataRows;
      if (currentFilterFamily) {
        filtered = filtered.filter(row => row.family === currentFilterFamily);
      }
      if (currentFilterFamilySearch) {
        filtered = filtered.filter(row => row.family.toLowerCase().includes(currentFilterFamilySearch));
      }
      filtered.sort((a, b) => a.meet.localeCompare(b.meet));

      const container = document.getElementById('report-container');
      const table = document.createElement('table');
      table.innerHTML = `<thead><tr>
        <th>Meet</th><th>Family</th><th>Swimmer(s)</th><th>Parent(s)</th>
        <th>Job(s)</th><th>Swam?</th><th>Worked?</th><th>Met?</th>
      </tr></thead><tbody>
        ${filtered.map(row => `
          <tr>
            <td>${row.meet}</td>
            <td>${row.family}</td>
            <td>${row.swimmers}</td>
            <td>${row.parents}</td>
            <td>${row.jobs}</td>
            <td>${row.competed}</td>
            <td>${row.volunteered}</td>
            <td class="met-${row.met === 'YES' ? 'yes' : 'no'}">${row.met}</td>
          </tr>`).join('')}
      </tbody>`;
      container.innerHTML = '';
      container.appendChild(table);
    }

    let currentFilterFamily = "";
    let currentFilterFamilySearch = "";

    async function generateFamilyReport() {
      const container = document.getElementById('report-container');
      try {
        const [swimmersRaw, volunteersRaw] = await Promise.all([
          loadJsonData(SWIMMER_DATA_URL, swimmerFields),
          loadJsonData(VOLUNTEER_DATA_URL, volunteerFields)
        ]);

        const reportMap = new Map();

        for (const row of swimmersRaw) {
          const meetDate = row["Meet Date"];
          const meetName = row["Meet Name"];
          const parent = row["Parent"];
          const swimmerNames = swimmerFields
            .filter(f => f.startsWith("Swimmer"))
            .map(field => row[field])
            .filter(Boolean);
          const competed = parseInt(row["Count of Events With Results"]) > 0;

          if (!meetDate || !meetName || !parent || swimmerNames.length === 0 || !competed) continue;

          const parentLastName = extractLastName(parent);
          const familyName = parentLastName;
          const parents = new Set([parent]); // current field
const parentKey = Array.from(parents).sort().join('|');
const key = `${meetDate}|${meetName}|${parentKey}`;

          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": meetDate,
              "Meet Name": meetName,
              "Family": familyName,
              "Parents": new Set([parent]),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }
          const entry = reportMap.get(key);
          swimmerNames.forEach(sw => entry.Swimmers.add(sw));
          entry.Competed = true;
        }

for (const row of volunteersRaw) {
  const meetDate = row["Meet Date"];
  const meetName = row["Meet Name"];
  const parents = row["Associated Parents For Swimmer"];
  if (!meetDate || !meetName || !parents) continue;

  const parentList = parents.split(";").map(p => p.trim()).filter(Boolean);

  // Try to find an existing entry that matches at least one of the parents
  let entryKey = null;
  for (const [k, v] of reportMap.entries()) {
    if (k.startsWith(`${meetDate}|${meetName}`)) {
      const existingParents = Array.from(v.Parents);
      if (parentList.some(p => existingParents.includes(p))) {
        entryKey = k;
        break;
      }
    }
  }

  // If no matching entry found, create a new one using sorted parent list
  if (!entryKey) {
    const parentKey = parentList.sort().join('|');
    entryKey = `${meetDate}|${meetName}|${parentKey}`;
    reportMap.set(entryKey, {
      "Meet Date": meetDate,
      "Meet Name": meetName,
      "Family": extractLastName(parentList[0]),
      "Parents": new Set(parentList),
      "Swimmers": new Set(),
      "Jobs": new Set(),
      "Competed": false,
      "Volunteered": false
    });
  }

  // Update the matching or new entry
  const entry = reportMap.get(entryKey);
  parentList.forEach(p => entry.Parents.add(p));
  entry.Volunteered = true;
}

        const allRows = Array.from(reportMap.values()).map(entry => {
          const met = entry.Competed ? (entry.Volunteered ? "YES" : "NO") : "N/A";
          return {
            meet: `${entry["Meet Date"].slice(5)} - ${entry["Meet Name"]}`,
            family: entry.Family,
            swimmers: Array.from(entry.Swimmers).map(extractFirstName).join(", ") || "-",
            parents: Array.from(entry.Parents).map(extractFirstName).join(", "),
            jobs: Array.from(entry.Jobs).join(", ") || "-",
            competed: entry.Competed ? "YES" : "NO",
            volunteered: entry.Volunteered ? "YES" : "NO",
            met: met
          };
        });

        updateFamilyDropdown([...new Set(allRows.map(r => r.family))]);
        applyFiltersAndRender(allRows);

        document.getElementById('familyNameFilterSelect').addEventListener('change', e => {
          currentFilterFamily = e.target.value;
          applyFiltersAndRender(allRows);
        });

        document.getElementById('familySearchInput').addEventListener('input', e => {
          currentFilterFamilySearch = e.target.value.toLowerCase();
          applyFiltersAndRender(allRows);
        });

      } catch (error) {
        container.innerHTML = `<p class="error">Error loading data: ${error.message}</p>`;
        console.error(error);
      }
    }

    document.addEventListener('DOMContentLoaded', generateFamilyReport);
  </script>
</body>
</html>
