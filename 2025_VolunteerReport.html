<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Requirement Report - Families</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }
    .main-content-wrapper {
      width: 890px;
      margin: 0 auto;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    .dropdown-container {
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.7em;
      position: sticky;
      top: 0;
      background-color: #f8f8f8;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #ccc;
    }
    .dropdown-box {
      display: inline-block;
      margin: 0 4px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }
    select, input[type="text"] {
      padding: 3px 6px;
      font-size: 0.7em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    table {
      table-layout: fixed;
      width: 100%;
      max-width: 890px;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 50px;
      z-index: 1;
      cursor: pointer;
      white-space: nowrap;
      color: #0156B3;
    }
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #eaf6ff; }
    .met-yes { font-weight: bold; color: #28a745; }
    .met-no { font-weight: bold; color: #dc3545; }
    .met-na { color: #6c757d; font-style: italic; }
  </style>
</head>
<body>
  <div class="main-content-wrapper">
    <h1>Volunteer Requirement Report (by Family)</h1>
    <p>This report summarizes each family's swimmer and volunteer participation per meet.<br>
    If a family had a swimmer compete, they should have had a parent volunteer.</p>

    <div class="dropdown-container">
      <div class="dropdown-box">
        <label for="familyFilterSelect">Family Name:</label>
        <select id="familyFilterSelect">
          <option value="">All Families</option>
        </select>
      </div>
      <div class="dropdown-box">
        <label for="complianceFilterSelect">Compliance:</label>
        <select id="complianceFilterSelect">
          <option value="">All Statuses</option>
          <option value="YES">Met (YES)</option>
          <option value="NO">Not Met (NO)</option>
          <option value="N/A">N/A</option>
        </select>
      </div>
    </div>

    <div id="report-container">Loading report data...</div>
  </div>

  <script>
    const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/main/2025_swimmerdata.json';
    const VOLUNTEER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/main/2025_volunteerdata.json';

    function formatMeetDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return "N/A";
      const parts = date.toDateString().split(" ");
      return `${parts[1]} ${parts[2]}`;
    }

    function extractLastName(name) {
      if (!name) return "";
      const parts = name.trim().split(" ");
      return parts.length > 1 ? parts.at(-1) : parts[0];
    }

    async function loadJsonData(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to load ${url}`);
      const raw = await res.json();
      return raw.values.map(row => Object.fromEntries(raw.fields.map((k, i) => [k, row[i]])));
    }

    async function generateFamilyReport() {
      const container = document.getElementById('report-container');
      let familyFilter = "";
      let complianceFilter = "";

      try {
        const [swimmers, volunteers] = await Promise.all([
          loadJsonData(SWIMMER_DATA_URL),
          loadJsonData(VOLUNTEER_DATA_URL)
        ]);

        const reportMap = new Map();
        const volunteerLastNameMap = {};
        const parentExpansionMap = {};

        volunteers.forEach(v => {
          const fullName = v["Parent"]?.trim();
          const lastName = v["Parent Last Name"]?.trim();
          if (fullName && lastName) {
            volunteerLastNameMap[fullName] = lastName;
            if (!parentExpansionMap[fullName]) parentExpansionMap[fullName] = new Set();
            parentExpansionMap[fullName].add(fullName);
          }
        });

        swimmers.forEach(s => {
          const parentString = s["Associated Parents For Swimmer"];
          const parentLastName = s["Parent Last Name"];
          if (parentString && parentLastName) {
            const parents = parentString.split(';').map(p => p.trim()).filter(Boolean);
            parents.forEach(p => {
              if (!parentExpansionMap[p]) parentExpansionMap[p] = new Set();
              parents.forEach(other => parentExpansionMap[p].add(other));
              if (!volunteerLastNameMap[p]) volunteerLastNameMap[p] = parentLastName;
            });
          }
        });

        const families = new Set();

        for (const row of swimmers) {
          const meetDate = row["Meet Date"];
          const meetName = row["Meet Name"];
          const swimmer = row["Swimmer Name"];
          const parents = row["Associated Parents For Swimmer"];
          if (!meetDate || !meetName || !swimmer || !parents || row["Count of Events With Results"] <= 0) continue;

          const parentSet = new Set();
          parents.split(';').forEach(p => {
            if (parentExpansionMap[p.trim()]) {
              parentExpansionMap[p.trim()].forEach(fam => parentSet.add(fam));
            } else {
              parentSet.add(p.trim());
            }
          });

          const parentSetKey = Array.from(parentSet).sort().join('|');
          const firstParent = parentSetKey.split('|')[0];
          const parentLastName = volunteerLastNameMap[firstParent] || extractLastName(firstParent);
          const familyName = `${parentLastName} Family`;
          const key = `${meetDate}|${meetName}|${parentSetKey}`;

          families.add(familyName);

          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": meetDate,
              "Meet Name": meetName,
              "Family": familyName,
              "Parents": new Set(parentSet),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }
          const entry = reportMap.get(key);
          entry.Swimmers.add(swimmer);
          entry.Competed = true;
        }

        for (const row of volunteers) {
          const meetDate = row["Meet Date"];
          const meetName = row["Meet Name"];
          const parent = row["Parent"]?.trim();
          const job = row["Job"]?.trim();
          if (!meetDate || !meetName || !parent || !job) continue;

          const parentSet = new Set();
          if (parentExpansionMap[parent]) {
            parentExpansionMap[parent].forEach(fam => parentSet.add(fam));
          } else {
            parentSet.add(parent);
          }
          const parentSetKey = Array.from(parentSet).sort().join('|');
          const firstParent = parentSetKey.split('|')[0];
          const parentLastName = volunteerLastNameMap[firstParent] || extractLastName(firstParent);
          const familyName = `${parentLastName} Family`;
          const key = `${meetDate}|${meetName}|${parentSetKey}`;

          families.add(familyName);

          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": meetDate,
              "Meet Name": meetName,
              "Family": familyName,
              "Parents": new Set(parentSet),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }
          const entry = reportMap.get(key);
          entry.Parents.add(parent);
          entry.Jobs.add(job);
          entry.Volunteered = true;
        }

        const allRows = Array.from(reportMap.values()).map(entry => {
          const met = entry.Competed ? (entry.Volunteered ? "YES" : "NO") : "N/A";
          return {
            meet: `${formatMeetDate(entry["Meet Date"])} - ${entry["Meet Name"]}`,
            family: entry.Family,
            swimmers: Array.from(entry.Swimmers).join(", ") || "-",
            parents: Array.from(entry.Parents).join(", "),
            jobs: Array.from(entry.Jobs).join(", ") || "-",
            competed: entry.Competed ? "YES" : "NO",
            volunteered: entry.Volunteered ? "YES" : "NO",
            met: met
          };
        });

        families.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          document.getElementById("familyFilterSelect").appendChild(option);
        });

        document.getElementById("familyFilterSelect").addEventListener("change", e => {
          familyFilter = e.target.value;
          renderTable();
        });

        document.getElementById("complianceFilterSelect").addEventListener("change", e => {
          complianceFilter = e.target.value;
          renderTable();
        });

        function renderTable() {
          const rows = allRows.filter(row => {
            const matchesFamily = !familyFilter || row.family === familyFilter;
            const matchesCompliance = !complianceFilter || row.met === complianceFilter;
            return matchesFamily && matchesCompliance;
          });

          const table = document.createElement('table');
          table.innerHTML = `<thead><tr>
            <th>Meet</th>
            <th>Family</th>
            <th>Swimmer(s)</th>
            <th>Parent(s)</th>
            <th>Job(s)</th>
            <th>Competed?</th>
            <th>Volunteered?</th>
            <th>Compliant?</th>
          </tr></thead><tbody>
            ${rows.map(row => `
              <tr>
                <td>${row.meet}</td>
                <td>${row.family}</td>
                <td>${row.swimmers}</td>
                <td>${row.parents}</td>
                <td>${row.jobs}</td>
                <td>${row.competed}</td>
                <td>${row.volunteered}</td>
                <td class="met-${row.met === 'YES' ? 'yes' : row.met === 'NO' ? 'no' : 'na'}">${row.met}</td>
              </tr>`).join('')}
          </tbody>`;

          container.innerHTML = '';
          container.appendChild(table);
        }

        renderTable();
      } catch (error) {
        container.innerHTML = `<p class="error">Error loading data: ${error.message}</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', generateFamilyReport);
  </script>
</body>
</html>
