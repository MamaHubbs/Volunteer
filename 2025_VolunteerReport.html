<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Requirement Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }
    .main-content-wrapper {
      width: 890px;
      margin: 0 auto;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    * { box-sizing: border-box; }
    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    .dropdown-container {
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.7em;
      position: sticky;
      top: 0;
      background-color: #f8f8f8;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #ccc;
    }
    .dropdown-box {
      display: inline-block;
      margin: 0 4px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }
    select, input[type="text"] {
      padding: 3px 6px;
      font-size: 0.7em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 4px 8px;
      font-size: 0.7em;
      border-radius: 4px;
      background-color: #0156B3;
      color: white;
      border: none;
      cursor: pointer;
    }
    .summary-stats-section {
      background-color: #e5f1ff;
      border: 1px solid #cce5ff;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      text-align: center;
      font-size: 0.9em;
      color: #0156B3;
    }
    .summary-stats-section h2 {
      font-size: 1.2em;
      margin-top: 0;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    .summary-stats-section p {
      margin: 5px 0;
      color: #34495e;
      font-weight: bold;
    }
    .summary-stats-section span {
      color: #0156B3;
    }
    table {
      table-layout: fixed;
      width: 100%;
      max-width: 890px;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 50px;
      z-index: 1;
      cursor: pointer;
      white-space: nowrap;
    }
    th.sortable::after {
      content: ' \21C5';
      font-size: 0.68em;
      color: #666;
      margin-left: 5px;
    }
    th.sortable.asc::after {
      content: ' \25B2';
      color: #0156B3;
    }
    th.sortable.desc::after {
      content: ' \25BC';
      color: #0156B3;
    }
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #eaf6ff; }
    .error {
      color: red;
      text-align: center;
      margin-top: 20px;
    }
    th:nth-child(1), td:nth-child(1) { width: 26%; }
    th:nth-child(2), td:nth-child(2) { width: 15%; }
    th:nth-child(3), td:nth-child(3) { width: 7%; text-align: center; }
    th:nth-child(4), td:nth-child(4) { width: 15%; }
    th:nth-child(5), td:nth-child(5) { width: 8%; }
    th:nth-child(6), td:nth-child(6) { width: 13%; }
    th:nth-child(7), td:nth-child(7) { width: 5%; text-align: center; }
    th:nth-child(8), td:nth-child(8) { width: 12%; }
    td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .competed-yes { background-color: #d4edda; }
    .competed-no { background-color: #f8d7da; }
    .met-yes { font-weight: bold; color: #28a745; }
    .met-no { font-weight: bold; color: #dc3545; }
    .met-na { color: #6c757d; font-style: italic; }
    .loading-message { color: #3498db; font-style: italic; text-align: center; padding: 20px; }
  </style>
</head>
<body>
  <div class="main-content-wrapper">
    <h1>Volunteer Requirement Report</h1>
    <p>This report compares swimmers who competed at a specific meet vs parents who volunteered at that specific meet. <br>
      <strong>Rule:</strong> If a family had a swimmer competing in a meet, a parent should have volunteered for that meet.</p>
    <div class="dropdown-container">
      <div class="dropdown-box">
        <label for="parentNameFilterSelect">Parent Name:</label>
        <select id="parentNameFilterSelect">
          <option value="">All Parents</option>
        </select>
      </div>
      <div class="dropdown-box">
        <label for="metRequirementFilterSelect">Met Requirement:</label>
        <select id="metRequirementFilterSelect">
          <option value="">All Statuses</option>
          <option value="YES">Met (YES)</option>
          <option value="NO">Not Met (NO)</option>
          <option value="N/A">N/A</option>
        </select>
      </div>
    </div>
    <div class="summary-stats-section">
      <h2>Summary for <span id="summary-context-label">All Parents</span></h2>
      <p>Meets Swum by Associated Children: <span id="total-meets-swum">0</span></p>
      <p>Meets Volunteered: <span id="total-meets-volunteered">0</span></p>
    </div>
    <div id="report-container" class="loading-message">Loading report data...</div>
  </div>

  <script>
    const PARENT_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_volunteerdata.json';
    const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_swimmerdata.json';

    let allReportRows = [];
    let currentSortKey = "Meet Date";
    let currentSortDirection = "asc";
    let currentFilterParentName = "";
    let currentFilterMetRequirement = "";

    function formatMeetDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return "N/A";
      return date.toLocaleDateString(undefined, { month: 'short', day: '2-digit' });
    }

    function parseDataclipJson(data) {
      if (!data || !Array.isArray(data.fields) || !Array.isArray(data.values)) return [];
      return data.values.map(row => Object.fromEntries(data.fields.map((f, i) => [f, row[i]])));
    }

    async function loadJsonData(url) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP error ${response.status}`);
      const rawData = await response.json();
      return parseDataclipJson(rawData);
    }

    function renderTableBody(dataRows) {
      const tbody = document.querySelector('#report-container tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (dataRows.length === 0) {
        tbody.insertAdjacentHTML('beforeend', `<tr><td colspan="8" style="text-align: center; color: #6c757d;">No results found for current filters.</td></tr>`);
        return;
      }

      dataRows.forEach(rowData => {
        const competedClass = rowData["Competed YES/NO"] === "YES" ? "competed-yes" : "competed-no";
        const metClass = rowData["Met Requirement"] === "YES" ? "met-yes" :
                         (rowData["Met Requirement"].startsWith("NO") ? "met-no" : "met-na");
        const meetDisplay = `${formatMeetDate(rowData["Meet Date"])} - ${rowData["Meet Name"] || "N/A"}`;
        const rowHtml = `
          <tr class="${competedClass}">
            <td>${meetDisplay}</td>
            <td>${rowData["Swimmer Name"] || "N/A"}</td>
            <td>${rowData["Competed YES/NO"] || "N/A"}</td>
            <td>${rowData["Parent Name"] || "N/A"}</td>
            <td>${rowData["Job"] || "N/A"}</td>
            <td>${rowData["Shift"] || "N/A"}</td>
            <td>${rowData["Points"] || "N/A"}</td>
            <td class="${metClass}">${rowData["Met Requirement"] || "N/A"}</td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', rowHtml);
      });
    }

    async function generateReport() {
      const container = document.getElementById('report-container');
      container.innerHTML = '<p class="loading-message">Processing data...</p>';
      let swimmersCompeting = [];
      let parentVolunteers = [];

      try {
        swimmersCompeting = await loadJsonData(SWIMMER_DATA_URL);
        parentVolunteers = await loadJsonData(PARENT_DATA_URL);
      } catch (error) {
        container.innerHTML = `<p class="error">Failed to load data: ${error.message}</p>`;
        return;
      }

      const competedSwimmersByMeet = {};
      swimmersCompeting.forEach(row => {
        const meetDate = row["Meet Date"];
        const meetName = row["Meet Name"];
        const swimmerName = row["Swimmer Name"];
        const countResults = row["Count of Events With Results"] || 0;
        const associatedParents = row["Associated Parents For Swimmer"];

        if (meetName && meetDate && swimmerName && countResults > 0) {
          if (!(meetName in competedSwimmersByMeet)) competedSwimmersByMeet[meetName] = {};
          if (!(meetDate in competedSwimmersByMeet[meetName])) competedSwimmersByMeet[meetName][meetDate] = {};
          competedSwimmersByMeet[meetName][meetDate][swimmerName] = associatedParents;
        }
      });

      const tempReportRows = [];
      const processedParentJobCombos = new Set();
      const processedSwimmerMeetCombos = new Set();

      parentVolunteers.forEach(row => {
        const meetDate = row["Meet Date"];
        const meetName = row["Meet Name"];
        const parentName = row.Parent;
        const job = row.Job;
        const shift = row.Shift;
        const points = row.Points;
        const parentJobId = `${meetDate}|${meetName}|${parentName}|${job}|${shift}|${points}`;

        if (processedParentJobCombos.has(parentJobId)) return;
        processedParentJobCombos.add(parentJobId);

        const associatedSwimmersList = [];
        for (let i = 1; i <= 9; i++) {
          const swimmerCol = row[`Swimmer ${i}`];
          if (swimmerCol) associatedSwimmersList.push(swimmerCol);
        }

        let competedStatus = "NO";
        for (const swimmer of associatedSwimmersList) {
          if (meetName in competedSwimmersByMeet &&
              meetDate in competedSwimmersByMeet[meetName] &&
              swimmer in competedSwimmersByMeet[meetName][meetDate]) {
            competedStatus = "YES";
            processedSwimmerMeetCombos.add(`${meetDate}|${meetName}|${swimmer}`);
          }
        }

        const metRequirement = (competedStatus === "YES") ? "YES" : "N/A";

        tempReportRows.push({
          "Meet Date": meetDate,
          "Meet Name": meetName,
          "Swimmer Name": associatedSwimmersList.length ? associatedSwimmersList.join(", ") : "N/A",
          "Competed YES/NO": competedStatus,
          "Parent Name": parentName,
          "Job": job,
          "Shift": shift,
          "Points": points,
          "Met Requirement": metRequirement,
          _allParentNamesForFilter: [parentName].filter(name => name !== "N/A (No Volunteer)")
        });
      });

      for (const meetName in competedSwimmersByMeet) {
        for (const meetDate in competedSwimmersByMeet[meetName]) {
          for (const swimmerName in competedSwimmersByMeet[meetName][meetDate]) {
            const swimmerParents = competedSwimmersByMeet[meetName][meetDate][swimmerName];
            if (!processedSwimmerMeetCombos.has(`${meetDate}|${meetName}|${swimmerName}`)) {
              tempReportRows.push({
                "Meet Date": meetDate,
                "Meet Name": meetName,
                "Swimmer Name": swimmerName,
                "Competed YES/NO": "YES",
                "Parent Name": swimmerParents,
                "Job": "N/A",
                "Shift": "N/A",
                "Points": "N/A",
                "Met Requirement": "NO",
                _allParentNamesForFilter: swimmerParents.split('; ').map(name => name.trim()).filter(name => name !== "No Parent Linked")
              });
            }
          }
        }
      }

      allReportRows = tempReportRows;

      const tableHtml = `
        <table>
          <thead>
            <tr>
              <th data-sort-key="Meet Date">Meet</th>
              <th data-sort-key="Swimmer Name">Swimmer(s)</th>
              <th data-sort-key="Competed YES/NO">Competed?</th>
              <th data-sort-key="Parent Name">Parent Name</th>
              <th data-sort-key="Job">Job</th>
              <th data-sort-key="Shift">Shift</th>
              <th data-sort-key="Points">Points</th>
              <th data-sort-key="Met Requirement">Compliant?</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>`;

      container.innerHTML = tableHtml;
      applyFiltersAndSort();
    }

    document.addEventListener('DOMContentLoaded', generateReport);
  </script>
</body>
</html>
