<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volunteer Requirement Report - Families</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }
    .main-content-wrapper {
      width: 890px;
      margin: 0 auto;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    table {
      table-layout: fixed;
      width: 100%;
      max-width: 890px;
      border-collapse: collapse;
      font-size: 0.85em;
      margin-top: 20px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #e5f1ff;
    }
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #eaf6ff; }
    .met-yes { font-weight: bold; color: #28a745; }
    .met-no { font-weight: bold; color: #dc3545; }
  </style>
</head>
<body>
  <div class="main-content-wrapper">
    <h1>Volunteer Requirement Report (by Family)</h1>
    <p>Each row represents a family's participation and volunteer status for a given meet.</p>
    <div id="report-container">Loading...</div>
  </div>
  <script>
    const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_swimmerdata.json';
    const VOLUNTEER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/refs/heads/main/2025_volunteerdata.json';

    function formatMeetDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return "N/A";
      const parts = date.toDateString().split(" ");
      return `${parts[1]} ${parts[2]}`;
    }

    function extractLastName(name) {
      return name?.split(" ").slice(-1)[0] || "";
    }

    async function loadJsonData(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to load ${url}`);
      const raw = await res.json();
      return raw.values.map(row => Object.fromEntries(raw.fields.map((k, i) => [k, row[i]])));
    }

    async function generateFamilyReport() {
      const container = document.getElementById('report-container');

      try {
        const [swimmers, volunteers] = await Promise.all([
          loadJsonData(SWIMMER_DATA_URL),
          loadJsonData(VOLUNTEER_DATA_URL)
        ]);

        const reportMap = new Map();

        // Step 1: process swimmers to identify families who had swimmers at each meet
        for (const row of swimmers) {
          const meetDate = row["Meet Date"];
          const meetName = row["Meet Name"];
          const swimmer = row["Swimmer Name"];
          const parents = row["Associated Parents For Swimmer"];
          if (!meetDate || !meetName || !swimmer || !parents || row["Count of Events With Results"] <= 0) continue;
          const familyName = `${extractLastName(parents.split(';')[0])} Family`;
          const key = `${meetDate}|${meetName}|${familyName}`;
          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": meetDate,
              "Meet Name": meetName,
              "Family": familyName,
              "Parents": new Set(parents.split(';').map(p => p.trim())),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }
          const entry = reportMap.get(key);
          entry.Swimmers.add(swimmer);
          entry.Competed = true;
        }

        // Step 2: process volunteers to identify who volunteered at what meet
        for (const row of volunteers) {
          const meetDate = row["Meet Date"];
          const meetName = row["Meet Name"];
          const parent = row["Parent"];
          const job = row["Job"];
          if (!meetDate || !meetName || !parent || !job) continue;
          const familyName = `${extractLastName(parent)} Family`;
          const key = `${meetDate}|${meetName}|${familyName}`;
          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": meetDate,
              "Meet Name": meetName,
              "Family": familyName,
              "Parents": new Set([parent]),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }
          const entry = reportMap.get(key);
          entry.Parents.add(parent);
          entry.Jobs.add(job);
          entry.Volunteered = true;
        }

        // Step 3: build rows
        const rows = Array.from(reportMap.values()).map(entry => {
          const met = entry.Competed ? (entry.Volunteered ? "YES" : "NO") : "N/A";
          return {
            meet: `${formatMeetDate(entry["Meet Date"])} - ${entry["Meet Name"]}`,
            family: entry.Family,
            swimmers: Array.from(entry.Swimmers).join(", ") || "-",
            parents: Array.from(entry.Parents).join(", "),
            jobs: Array.from(entry.Jobs).join(", ") || "-",
            competed: entry.Competed ? "YES" : "NO",
            volunteered: entry.Volunteered ? "YES" : "NO",
            met: met
          };
        });

        // Step 4: render table
        const table = document.createElement('table');
        table.innerHTML = `<thead><tr>
          <th>Meet</th>
          <th>Family</th>
          <th>Swimmer(s)</th>
          <th>Parent(s)</th>
          <th>Job(s)</th>
          <th>Competed?</th>
          <th>Volunteered?</th>
          <th>Compliant?</th>
        </tr></thead><tbody>
          ${rows.map(row => `
            <tr>
              <td>${row.meet}</td>
              <td>${row.family}</td>
              <td>${row.swimmers}</td>
              <td>${row.parents}</td>
              <td>${row.jobs}</td>
              <td>${row.competed}</td>
              <td>${row.volunteered}</td>
              <td class="met-${row.met === 'YES' ? 'yes' : 'no'}">${row.met}</td>
            </tr>`).join('')}
        </tbody>`;

        container.innerHTML = '';
        container.appendChild(table);
      } catch (error) {
        container.innerHTML = `<p class="error">Error loading data: ${error.message}</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', generateFamilyReport);
  </script>
</body>
</html>
