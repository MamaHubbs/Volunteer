<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Volunteer Requirement Report - Families</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }
    .main-content-wrapper {
      width: 890px;
      margin: 0 auto;
      overflow-x: auto;
      box-sizing: border-box;
      padding: 10px;
    }
    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }
    p {
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    .dropdown-container {
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.7em;
      position: sticky;
      top: 0;
      background-color: #f8f8f8;
      padding: 10px 0;
      z-index: 1000;
      border-bottom: 1px solid #ccc;
    }
    .dropdown-box {
      display: inline-block;
      margin: 0 4px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }
    select {
      padding: 3px 6px;
      font-size: 0.7em;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    table {
      table-layout: fixed;
      width: 100%;
      max-width: 890px;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 50px;
      z-index: 1;
      cursor: pointer;
      white-space: nowrap;
      color: #0156B3;
    }
    th.sortable::after {
      content: ' \21C5';
      font-size: 0.68em;
      color: #666;
      margin-left: 5px;
    }
    th.sortable.asc::after {
      content: ' \25B2';
      color: #0156B3;
    }
    th.sortable.desc::after {
      content: ' \25BC';
      color: #0156B3;
    }
    tbody tr:nth-child(even) { background-color: #fdfdfd; }
    tbody tr:nth-child(odd) { background-color: #ffffff; }
    tbody tr:hover { background-color: #eaf6ff; }
    .met-yes { font-weight: bold; color: #28a745; }
    .met-no { font-weight: bold; color: #dc3545; }
    .met-na { color: #6c757d; font-style: italic; }
    .error { color: red; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="main-content-wrapper">
    <h1>Volunteer Requirement Report (by Family)</h1>
    <p>This report summarizes each family's swimmer and volunteer participation per meet.<br>
    If a family had a swimmer compete, they should have had a parent volunteer.</p>

    <div class="dropdown-container">
      <div class="dropdown-box">
        <label for="familyFilterSelect">Family Name:</label>
        <select id="familyFilterSelect">
          <option value="">All Families</option>
        </select>
      </div>
      <div class="dropdown-box">
        <label for="complianceFilterSelect">Compliance:</label>
        <select id="complianceFilterSelect">
          <option value="">All Statuses</option>
          <option value="YES">Met (YES)</option>
          <option value="NO">Not Met (NO)</option>
          <option value="N/A">N/A</option>
        </select>
      </div>
    </div>

    <div id="report-container">Loading report data...</div>
  </div>

  <script>
    const SWIMMER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/main/2025_swimmerdata.json';
    const VOLUNTEER_DATA_URL = 'https://raw.githubusercontent.com/MamaHubbs/Volunteer/main/2025_volunteerdata.json';

    function formatMeetDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return "N/A";
      const parts = date.toDateString().split(" ");
      return `${parts[1]} ${parts[2]}`;
    }

    function getLastNameFromCommaFormat(name) {
      if (!name) return "";
      const parts = name.split(',');
      return parts[0].trim();
    }

    async function loadJsonData(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Failed to load ${url}`);
      const raw = await res.json();
      return raw.values.map(row => Object.fromEntries(raw.fields.map((k, i) => [k, row[i]])));
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const container = document.getElementById('report-container');
      let familyFilter = "";
      let complianceFilter = "";
      let currentSortKey = "Meet";
      let currentSortDirection = "asc";

      try {
        const [swimmers, volunteers] = await Promise.all([
          loadJsonData(SWIMMER_DATA_URL),
          loadJsonData(VOLUNTEER_DATA_URL)
        ]);

        const reportMap = new Map();
        const families = new Set();

        swimmers.forEach(row => {
          const meetKey = `${row["Meet Date"]}|${row["Meet Name"]}`;
          const swimmer = row["Swimmer Name"];
          const parents = row["Associated Parents For Swimmer"] || "";
          const parentLastNames = parents.split(';').map(p => getLastNameFromCommaFormat(p.trim()));
          const familyName = parentLastNames[0] ? `${parentLastNames[0]} Family` : "Unknown Family";
          const key = `${meetKey}|${familyName}`;

          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": row["Meet Date"],
              "Meet Name": row["Meet Name"],
              "Family": familyName,
              "Parents": new Set(parents.split(';').map(p => p.trim())),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }

          const entry = reportMap.get(key);
          entry.Swimmers.add(swimmer);
          entry.Competed = true;
          families.add(familyName);
        });

        volunteers.forEach(row => {
          const meetKey = `${row["Meet Date"]}|${row["Meet Name"]}`;
          const parent = row["Parent"];
          const swimmers = [row["Swimmer 1"], row["Swimmer 2"], row["Swimmer 3"], row["Swimmer 4"], row["Swimmer 5"], row["Swimmer 6"], row["Swimmer 7"], row["Swimmer 8"], row["Swimmer 9"]].filter(Boolean);
          const parentLastName = getLastNameFromCommaFormat(parent);
          const familyName = parentLastName ? `${parentLastName} Family` : "Unknown Family";
          const key = `${meetKey}|${familyName}`;

          if (!reportMap.has(key)) {
            reportMap.set(key, {
              "Meet Date": row["Meet Date"],
              "Meet Name": row["Meet Name"],
              "Family": familyName,
              "Parents": new Set(),
              "Swimmers": new Set(),
              "Jobs": new Set(),
              "Competed": false,
              "Volunteered": false
            });
          }

          const entry = reportMap.get(key);
          entry.Parents.add(parent);
          swimmers.forEach(s => entry.Swimmers.add(s));
          if (row["Job"]) entry.Jobs.add(row["Job"]);
          entry.Volunteered = true;
          families.add(familyName);
        });

        const allRows = Array.from(reportMap.values()).map(entry => {
          const met = entry.Competed ? (entry.Volunteered ? "YES" : "NO") : "N/A";
          return {
            meet: `${formatMeetDate(entry["Meet Date"])} - ${entry["Meet Name"]}`,
            family: entry.Family,
            swimmers: Array.from(entry.Swimmers).join(", ") || "-",
            parents: Array.from(entry.Parents).join(", "),
            jobs: Array.from(entry.Jobs).join(", ") || "-",
            competed: entry.Competed ? "YES" : "NO",
            volunteered: entry.Volunteered ? "YES" : "NO",
            met: met
          };
        });

        families.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          document.getElementById("familyFilterSelect").appendChild(option);
        });

        document.getElementById("familyFilterSelect").addEventListener("change", e => {
          familyFilter = e.target.value;
          renderTable();
        });

        document.getElementById("complianceFilterSelect").addEventListener("change", e => {
          complianceFilter = e.target.value;
          renderTable();
        });

        function renderTable() {
          let rows = [...allRows];

          if (familyFilter) rows = rows.filter(row => row.family === familyFilter);
          if (complianceFilter) rows = rows.filter(row => row.met === complianceFilter);

          rows.sort((a, b) => {
            const valA = a[currentSortKey] || "";
            const valB = b[currentSortKey] || "";
            return currentSortDirection === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });

          const table = document.createElement('table');
          table.innerHTML = `<thead><tr>
            <th class="sortable" data-key="meet">Meet</th>
            <th class="sortable" data-key="family">Family</th>
            <th class="sortable" data-key="swimmers">Swimmer(s)</th>
            <th class="sortable" data-key="parents">Parent(s)</th>
            <th class="sortable" data-key="jobs">Job(s)</th>
            <th class="sortable" data-key="competed">Competed?</th>
            <th class="sortable" data-key="volunteered">Volunteered?</th>
            <th class="sortable" data-key="met">Compliant?</th>
          </tr></thead><tbody>
            ${rows.map(row => `
              <tr>
                <td>${row.meet}</td>
                <td>${row.family}</td>
                <td>${row.swimmers}</td>
                <td>${row.parents}</td>
                <td>${row.jobs}</td>
                <td>${row.competed}</td>
                <td>${row.volunteered}</td>
                <td class="met-${row.met === 'YES' ? 'yes' : row.met === 'NO' ? 'no' : 'na'}">${row.met}</td>
              </tr>`).join('')}
          </tbody>`;

          container.innerHTML = '';
          container.appendChild(table);

          document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.key === currentSortKey) th.classList.add(currentSortDirection);
            th.onclick = () => {
              const key = th.dataset.key;
              if (currentSortKey === key) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
              } else {
                currentSortKey = key;
                currentSortDirection = 'asc';
              }
              renderTable();
            };
          });
        }

        renderTable();
      } catch (error) {
        container.innerHTML = `<p class="error">Error loading data: ${error.message}</p>`;
      }
    });
  </script>
</body>
</html>
